<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>科学计算器（增强版）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            padding: 20px;
        }
        
        .calculator-container {
            width: 100%;
            max-width: 400px;
            background-color: #2c3e50;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }
        
        .display {
            background-color: #1a2530;
            padding: 25px 20px;
            text-align: right;
            border-bottom: 2px solid #34495e;
        }
        
        .expression {
            min-height: 24px;
            font-size: 18px;
            color: #bdc3c7;
            margin-bottom: 10px;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .result {
            font-size: 36px;
            font-weight: bold;
            color: #ecf0f1;
            min-height: 50px;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .history-panel, .storage-panel {
            background-color: #34495e;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }
        
        .history-item, .storage-item {
            padding: 8px 0;
            border-bottom: 1px solid #2c3e50;
            color: #ecf0f1;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:last-child, .storage-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover, .storage-item:hover {
            background-color: #3d566e;
        }
        
        .storage-value {
            font-weight: bold;
            color: #f1c40f;
        }
        
        .copy-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .calculator-body {
            padding: 20px;
        }
        
        .panel-toggle {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
            width: 100%;
            font-size: 16px;
        }
        
        .panel-toggle:hover {
            background: #2980b9;
        }
        
        .buttons-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }
        
        button {
            padding: 16px 0;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #34495e;
            color: #ecf0f1;
            box-shadow: 0 4px 0 #2c3e50;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #2c3e50;
        }
        
        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #2c3e50;
        }
        
        .number, .decimal {
            background-color: #3d566e;
        }
        
        .operator {
            background-color: #3498db;
        }
        
        .function {
            background-color: #9b59b6;
        }
        
        .equals {
            background-color: #2ecc71;
            grid-column: span 2;
        }
        
        .clear, .backspace {
            background-color: #e74c3c;
        }
        
        .constant {
            background-color: #f39c12;
        }
        
        .storage-btn {
            background-color: #16a085;
        }
        
        .power-btn {
            background-color: #e67e22;
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            color: #bdc3c7;
            font-size: 14px;
            background-color: #1a2530;
        }
        
        /* 隐藏输入框，用于粘贴 */
        #pasteInput {
            position: absolute;
            opacity: 0;
            width: 1px;
            height: 1px;
            pointer-events: none;
        }
        
        /* 存储提示 */
        #storageNotification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(26, 188, 156, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        #storageNotification.show {
            opacity: 1;
        }
        
        @media (max-width: 480px) {
            .buttons-grid {
                gap: 8px;
                padding: 10px;
            }
            
            button {
                padding: 12px 0;
                font-size: 16px;
            }
            
            .result {
                font-size: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <div class="display">
            <div class="expression" id="expression"></div>
            <div class="result" id="result">0</div>
        </div>
        
        <div class="history-panel" id="historyPanel">
            <!-- 历史记录将在这里显示 -->
        </div>
        
        <div class="storage-panel" id="storagePanel">
            <!-- 存储记录将在这里显示 -->
        </div>
        
        <div class="calculator-body">
            <button class="panel-toggle" id="historyToggle">显示历史记录</button>
            <button class="panel-toggle" id="storageToggle">显示存储记录</button>
            
            <div class="buttons-grid">
                <!-- 第一行 -->
                <button class="function" onclick="insertFunction('sin')">sin</button>
                <button class="function" onclick="insertFunction('cos')">cos</button>
                <button class="function" onclick="insertFunction('tan')">tan</button>
                <button class="function" onclick="insertFunction('log')">log</button>
                <button class="function" onclick="insertFunction('ln')">ln</button>
                
                <!-- 第二行 -->
                <button class="function" onclick="applyFunctionToCurrent('sqrt')">√</button>
                <button class="function" onclick="applyFunctionToCurrent('cbrt')">∛</button>
                <button class="function" onclick="insertFunction('nthroot')">n√</button>
                <button class="function" onclick="insertFunction('square')">x²</button>
                <button class="function" onclick="insertFunction('cube')">x³</button>
                
                <!-- 第三行 -->
                <button class="clear" onclick="clearDisplay()">C</button>
                <button class="backspace" onclick="backspace()">⌫</button>
                <button class="operator" onclick="appendToDisplay('/')">/</button>
                <button class="operator" onclick="appendToDisplay('*')">×</button>
                <button class="operator" onclick="appendToDisplay('-')">-</button>
                
                <!-- 第四行 -->
                <button class="number" onclick="appendToDisplay('7')">7</button>
                <button class="number" onclick="appendToDisplay('8')">8</button>
                <button class="number" onclick="appendToDisplay('9')">9</button>
                <button class="operator" onclick="appendToDisplay('+')">+</button>
                <button class="operator" onclick="appendToDisplay('(')">(</button>
                
                <!-- 第五行 -->
                <button class="number" onclick="appendToDisplay('4')">4</button>
                <button class="number" onclick="appendToDisplay('5')">5</button>
                <button class="number" onclick="appendToDisplay('6')">6</button>
                <button class="operator" onclick="appendToDisplay('^')">^</button>
                <button class="operator" onclick="appendToDisplay(')')">)</button>
                
                <!-- 第六行 -->
                <button class="number" onclick="appendToDisplay('1')">1</button>
                <button class="number" onclick="appendToDisplay('2')">2</button>
                <button class="number" onclick="appendToDisplay('3')">3</button>
                <button class="equals" onclick="calculate()">=</button>
                <button class="operator" onclick="appendToDisplay(',')">,</button>
                
                <!-- 第七行 -->
                <button class="number" onclick="appendToDisplay('0')">0</button>
                <button class="decimal" onclick="appendToDisplay('.')">.</button>
                <button class="function" onclick="applyFunctionToCurrent('abs')">|x|</button>
                <button class="function" onclick="insertFunction('power')">x^y</button>
                <button class="storage-btn" onclick="storeResult()">存储</button>
            </div>
        </div>
        
        <div class="footer">
            科学计算器（增强版） | 支持三角函数、对数、幂运算等
        </div>
        
        <!-- 隐藏输入框用于粘贴 -->
        <input type="text" id="pasteInput" placeholder="粘贴内容">
        
        <!-- 存储提示 -->
        <div id="storageNotification">已存储</div>
    </div>

    <script>
        // 当前显示值
        let currentDisplay = '0';
        // 表达式显示
        let expression = '';
        // 历史记录
        let history = [];
        // 存储记录
        let storage = [];
        
        // 更新显示
        function updateDisplay() {
            document.getElementById('result').innerText = currentDisplay;
            document.getElementById('expression').innerText = expression;
        }
        
        // 添加到显示
        function appendToDisplay(value) {
            if (currentDisplay === '0' && value !== '.') {
                currentDisplay = value;
            } else {
                currentDisplay += value;
            }
            
            // 更新表达式显示
            expression = currentDisplay;
            updateDisplay();
        }
        
        // 清除显示
        function clearDisplay() {
            currentDisplay = '0';
            expression = '';
            updateDisplay();
        }
        
        // 退格
        function backspace() {
            if (currentDisplay.length > 1) {
                currentDisplay = currentDisplay.slice(0, -1);
            } else {
                currentDisplay = '0';
            }
            
            expression = currentDisplay;
            updateDisplay();
        }
        
        // 插入函数
        function insertFunction(func) {
            switch(func) {
                case 'sin':
                    appendToDisplay('sin(');
                    break;
                case 'cos':
                    appendToDisplay('cos(');
                    break;
                case 'tan':
                    appendToDisplay('tan(');
                    break;
                case 'log':
                    appendToDisplay('log(');
                    break;
                case 'ln':
                    appendToDisplay('ln(');
                    break;
                case 'sqrt':
                    appendToDisplay('sqrt(');
                    break;
                case 'cbrt':
                    appendToDisplay('cbrt(');
                    break;
                case 'nthroot':
                    appendToDisplay('nthroot(');
                    break;
                case 'square':
                    appendToDisplay('^2');
                    break;
                case 'cube':
                    appendToDisplay('^3');
                    break;
                case 'power':
                    appendToDisplay('^');
                    break;
                default:
                    appendToDisplay(func + '(');
            }
        }
        
        // 应用函数到当前显示值
        function applyFunctionToCurrent(func) {
            // 尝试将当前显示转换为数字
            const currentValue = parseFloat(currentDisplay);
            
            if (!isNaN(currentValue)) {
                let result;
                
                switch(func) {
                    case 'sqrt':
                        result = Math.sqrt(currentValue);
                        break;
                    case 'cbrt':
                        result = Math.cbrt(currentValue);
                        break;
                    case 'abs':
                        result = Math.abs(currentValue);
                        break;
                    default:
                        return;
                }
                
                // 添加到历史记录
                history.unshift({
                    expression: `${func}(${currentValue})`,
                    result: parseFloat(result.toFixed(10)).toString()
                });
                
                // 限制历史记录数量
                if (history.length > 10) {
                    history = history.slice(0, 10);
                }
                
                // 更新显示
                expression = `${func}(${currentValue})`;
                currentDisplay = parseFloat(result.toFixed(10)).toString();
                updateDisplay();
                
                // 更新历史面板
                updateHistoryPanel();
            } else {
                // 如果当前显示不是纯数字，按原方式处理
                switch(func) {
                    case 'sqrt':
                        appendToDisplay('sqrt(');
                        break;
                    case 'cbrt':
                        appendToDisplay('cbrt(');
                        break;
                    case 'abs':
                        appendToDisplay('abs(');
                        break;
                }
            }
        }
        
        // 计算结果
        function calculate() {
            try {
                // 替换显示符号为JavaScript可识别的符号
                let expressionToEvaluate = currentDisplay
                    .replace(/×/g, '*')
                    .replace(/÷/g, '/')
                    .replace(/π/g, 'Math.PI')
                    .replace(/e/g, 'Math.E')
                    .replace(/\^2/g, '**2')
                    .replace(/\^3/g, '**3')
                    .replace(/\^/g, '**')
                    .replace(/sin\(/g, 'sinDeg(')
                    .replace(/cos\(/g, 'cosDeg(')
                    .replace(/tan\(/g, 'tanDeg(')
                    .replace(/log\(/g, 'Math.log10(')
                    .replace(/ln\(/g, 'Math.log(')
                    .replace(/sqrt\(/g, 'Math.sqrt(')
                    .replace(/cbrt\(/g, 'Math.cbrt(')
                    .replace(/nthroot\(/g, 'nthRoot(')
                    .replace(/\|([^\|]+)\|/g, 'Math.abs($1)') // 处理绝对值
                    .replace(/10\^\(/g, 'Math.pow(10,'); // 处理10^x
                
                // 处理阶乘
                expressionToEvaluate = expressionToEvaluate.replace(/(\d+)!/g, function(match, number) {
                    return factorial(parseInt(number));
                });
                
                // 定义角度制三角函数
                const sinDeg = (deg) => Math.sin(deg * Math.PI / 180);
                const cosDeg = (deg) => Math.cos(deg * Math.PI / 180);
                const tanDeg = (deg) => Math.tan(deg * Math.PI / 180);
                
                // 定义n次根函数
                const nthRoot = (x, n) => {
                    if (n === 0) return NaN;
                    if (x < 0 && n % 2 === 0) return NaN; // 负数的偶次根不存在
                    if (x < 0 && n % 2 === 1) return -Math.pow(-x, 1/n); // 负数的奇次根
                    return Math.pow(x, 1/n);
                };
                
                // 计算结果
                let result = eval(expressionToEvaluate);
                
                // 格式化结果
                if (result === Infinity) {
                    result = '∞';
                } else if (result === -Infinity) {
                    result = '-∞';
                } else if (isNaN(result)) {
                    result = '错误';
                } else {
                    // 限制小数位数
                    result = parseFloat(result.toFixed(10)).toString();
                }
                
                // 添加到历史记录
                history.unshift({
                    expression: currentDisplay,
                    result: result
                });
                
                // 限制历史记录数量
                if (history.length > 10) {
                    history = history.slice(0, 10);
                }
                
                // 更新显示
                expression = currentDisplay + ' =';
                currentDisplay = result;
                updateDisplay();
                
                // 更新历史面板
                updateHistoryPanel();
            } catch (error) {
                currentDisplay = '错误';
                updateDisplay();
            }
        }
        
        // 计算阶乘
        function factorial(n) {
            if (n < 0) return NaN;
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }
        
        // 存储当前结果
        function storeResult() {
            if (currentDisplay !== '0' && currentDisplay !== '错误') {
                // 存储格式：{ id: 记录ID, value: 存储值, timestamp: 时间戳 }
                const newStorageItem = {
                    id: storage.length + 1,
                    value: currentDisplay,
                    timestamp: new Date().toLocaleTimeString()
                };
                
                // 添加到存储记录
                storage.unshift(newStorageItem);
                
                // 限制存储记录数量
                if (storage.length > 10) {
                    storage = storage.slice(0, 10);
                }
                
                // 更新存储面板
                updateStoragePanel();
                
                // 显示存储提示
                showStorageNotification(`已存储: ${currentDisplay}`);
            } else {
                showStorageNotification('无法存储当前值');
            }
        }
        
        // 显示存储提示
        function showStorageNotification(message) {
            const notification = document.getElementById('storageNotification');
            notification.textContent = message;
            notification.classList.add('show');
            
            // 0.5秒后开始淡出
            setTimeout(() => {
                notification.classList.remove('show');
            }, 500);
        }
        
        // 更新历史面板
        function updateHistoryPanel() {
            const historyPanel = document.getElementById('historyPanel');
            historyPanel.innerHTML = '';
            
            if (history.length === 0) {
                historyPanel.innerHTML = '<div class="history-item">暂无历史记录</div>';
                return;
            }
            
            history.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `<div>${item.expression} =</div><div style="text-align:right; font-weight:bold;">${item.result}</div>`;
                historyItem.onclick = () => {
                    currentDisplay = item.result;
                    expression = '';
                    updateDisplay();
                };
                historyPanel.appendChild(historyItem);
            });
        }
        
        // 更新存储面板
        function updateStoragePanel() {
            const storagePanel = document.getElementById('storagePanel');
            storagePanel.innerHTML = '';
            
            if (storage.length === 0) {
                storagePanel.innerHTML = '<div class="storage-item">暂无存储记录</div>';
                return;
            }
            
            storage.forEach((item, index) => {
                const storageItem = document.createElement('div');
                storageItem.className = 'storage-item';
                
                // 创建内容和复制按钮
                const contentDiv = document.createElement('div');
                contentDiv.innerHTML = `<div>存储 ${item.id}:</div><div class="storage-value">${item.value}</div>`;
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = '复制';
                copyBtn.onclick = (e) => {
                    e.stopPropagation(); // 防止触发父元素点击事件
                    copyToClipboard(item.value);
                };
                
                storageItem.appendChild(contentDiv);
                storageItem.appendChild(copyBtn);
                
                storageItem.onclick = () => {
                    // 点击存储项时，将值插入到当前显示中
                    if (currentDisplay === '0') {
                        currentDisplay = item.value;
                    } else {
                        currentDisplay = currentDisplay + item.value;
                    }
                    expression = currentDisplay;
                    updateDisplay();
                };
                
                storagePanel.appendChild(storageItem);
            });
        }
        
        // 复制到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showStorageNotification('已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败: ', err);
                // 降级方案：使用旧方法
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStorageNotification('已复制到剪贴板');
            });
        }
        
        // 切换历史面板显示
        document.getElementById('historyToggle').addEventListener('click', function() {
            const historyPanel = document.getElementById('historyPanel');
            const storagePanel = document.getElementById('storagePanel');
            
            if (historyPanel.style.display === 'block') {
                historyPanel.style.display = 'none';
                this.textContent = '显示历史记录';
            } else {
                historyPanel.style.display = 'block';
                this.textContent = '隐藏历史记录';
                storagePanel.style.display = 'none';
                document.getElementById('storageToggle').textContent = '显示存储记录';
            }
        });
        
        // 切换存储面板显示
        document.getElementById('storageToggle').addEventListener('click', function() {
            const storagePanel = document.getElementById('storagePanel');
            const historyPanel = document.getElementById('historyPanel');
            
            if (storagePanel.style.display === 'block') {
                storagePanel.style.display = 'none';
                this.textContent = '显示存储记录';
            } else {
                storagePanel.style.display = 'block';
                this.textContent = '隐藏存储记录';
                historyPanel.style.display = 'none';
                document.getElementById('historyToggle').textContent = '显示历史记录';
            }
        });
        
        // 初始化显示
        updateDisplay();
        
        // 粘贴功能
        document.getElementById('pasteInput').addEventListener('paste', function(e) {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            // 将粘贴的内容添加到当前显示
            if (currentDisplay === '0') {
                currentDisplay = paste;
            } else {
                currentDisplay += paste;
            }
            expression = currentDisplay;
            updateDisplay();
        });
        
        // 监听 Ctrl+V 粘贴事件
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                e.preventDefault();
                document.getElementById('pasteInput').focus();
                document.getElementById('pasteInput').select();
            }
        });
        
        // 键盘支持
        document.addEventListener('keydown', function(event) {
            const key = event.key;
            
            if (/[0-9]/.test(key)) {
                appendToDisplay(key);
            } else if (key === '.') {
                appendToDisplay('.');
            } else if (key === '+' || key === '-' || key === '*' || key === '/') {
                appendToDisplay(key);
            } else if (key === 'Enter' || key === '=') {
                calculate();
            } else if (key === 'Escape') {
                clearDisplay();
            } else if (key === 'Backspace') {
                backspace();
            } else if (key === '(') {
                appendToDisplay(key);
            } else if (key === ')') {
                appendToDisplay(key);
            } else if (key === '^') {
                appendToDisplay('^');
            } else if (key === ',') {
                appendToDisplay(',');
            }
        });
    </script>
</body>
</html>